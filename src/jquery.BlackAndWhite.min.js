/** 
* 
* Version: 0.3.2 
* Author:  Gianluca Guarini
* Contact: gianluca.guarini@gmail.com
* Website: http://www.gianlucaguarini.com
* Twitter: @gianlucaguarini
*
* Copyright (c) Gianluca Guarini
*/
!function(a){a.fn.extend({BlackAndWhite:function(b){"use strict";var c=this,d=a.extend({hoverEffect:!0,webworkerPath:!1,responsive:!0,invertHoverEffect:!1,speed:500,onImageReady:null,intensity:1},b),e=d.hoverEffect,f=d.webworkerPath,g=d.invertHoverEffect,h=d.responsive,i="number"==typeof d.intensity&&d.intensity<1&&d.intensity>0?d.intensity:1,j=a.isPlainObject(d.speed)?d.speed.fadeIn:d.speed,k=a.isPlainObject(d.speed)?d.speed.fadeOut:d.speed,l=a(window),m=document.all&&!window.opera&&window.XMLHttpRequest?!0:!1,n=" -webkit- -moz- -o- -ms- ".split(" "),o={},p=function(a){if(o[a]||""===o[a])return o[a]+a;var b=document.createElement("div"),c=["","Moz","Webkit","O","ms","Khtml"];for(var d in c)if("undefined"!=typeof b.style[c[d]+a])return o[a]=c[d],c[d]+a;return a.toLowerCase()},q=function(){var a=document.createElement("div");return a.style.cssText=n.join("filter:blur(2px); "),!!a.style.length&&(void 0===document.documentMode||document.documentMode>9)}(),r=!!document.createElement("canvas").getContext,s=function(){return"undefined"!=typeof Worker?!0:!1}(),t=p("Filter"),u=[],v=s&&f?new Worker(f+"BnWWorker.js"):!1,w=function(b){a(b.currentTarget).find(".BWfade").stop(!0,!0)[g?"fadeOut":"fadeIn"](k)},x=function(b){a(b.currentTarget).find(".BWfade").stop(!0,!0)[g?"fadeIn":"fadeOut"](j)},y=function(a){"function"==typeof d.onImageReady&&d.onImageReady(a)},z=function(a){v&&r&&!q&&!a&&A()},A=function(){return u.length?(v.postMessage({imgData:u[0].imageData,intensity:i}),void(v.onmessage=function(a){u[0].ctx.putImageData(a.data,0,0),y(u[0].img),u.splice(0,1),A()})):(v.terminate&&v.terminate(),void(v.close&&v.close()))},B=function(a){return a.complete||"undefined"!=typeof a.naturalWidth&&a.naturalWidth},C=function(a,b,c,d){var e=b.getContext("2d"),f=0;e.drawImage(a,0,0,c,d);var g=e.getImageData(0,0,c,d),h=g.data,j=h.length;if(v)u.push({imageData:g,ctx:e,img:a});else{for(;j>f;f+=4){var k=.3*h[f]+.59*h[f+1]+.11*h[f+2];h[f]=~~(k*i+h[f]*(1-i)),h[f+1]=~~(k*i+h[f+1]*(1-i)),h[f+2]=~~(k*i+h[f+2]*(1-i))}e.putImageData(g,0,0),y(a)}},D=function(b,c){var d,e=b[0],f=e.src,h=b.width(),j=b.height(),k=b.position(),l={position:"absolute","-webkit-transform":"translate3d(0,0,0)",top:k.top,left:k.left,display:g?"none":"block"};if(e.crossOrigin="anonymous",r&&!q){var m=e.width,n=e.height;d=a('<canvas class="BWfade" width="'+m+'" height="'+n+'"></canvas>'),d.css(l),d.prependTo(c),C(e,d.get(0),m,n)}else l[t]="grayscale("+100*i+"%)",d=a("<img src="+f+' width="'+h+'" height="'+j+'" class="BWFilter BWfade" /> '),d.css(a.extend(l,{filter:"progid:DXImageTransform.Microsoft.BasicImage(grayscale=1)"})),d.prependTo(c),y(e)};return this.init=function(){var b=c.find("img").filter(function(){return!a(this).data("_b&w")}).length;c.each(function(c,d){var e=a(d),f=e.find("img");f.data("_b&w")||(B(f[0])?(b--,D(f,e)):f.on("load",function(){return f.data("_b&w_loaded")||!f[0].complete?void setTimeout(function(){f.load()},20):(D(f,e),f.data("_b&w_loaded",!0),b--,void z(b))}).load(),f.data("_b&w",!0))}),z(b),e&&(c.on("mouseleave",w),c.on("mouseenter",x)),h&&l.on("resize orientationchange",this.resizeImages)},this.resizeImages=function(){c.each(function(b,c){var d=a(c).find("img:not(.BWFilter)"),e=m?a(d).prop("width"):a(d).width(),f=m?a(d).prop("height"):a(d).height();a(this).find(".BWFilter, canvas").css({width:e,height:f})})},this.init(d)}})}(jQuery);